<template>
  <div class="flow-builder" v-if="entryItem" ref="flowBuilder">
    <div class="zoom-element" @mousedown="blockEvent">
      <el-slider
        v-model="scale"
        :min=".1"
        :max="2"
        :step=".1"
      >
      </el-slider>
      <div class="go-to-position" @click="findEntryStep">
        <svg x="0px" y="0px" fill="#409EFF" viewBox="0 0 384 384" style="enable-background:new 0 0 384 384;" xml:space="preserve">
          <path d="M192,136c-30.872,0-56,25.12-56,56s25.128,56,56,56s56-25.12,56-56S222.872,136,192,136z M192,216
            c-13.232,0-24-10.768-24-24s10.768-24,24-24s24,10.768,24,24S205.232,216,192,216z"/>
          <path d="M368,176h-32.944C327.648,109.368,274.632,56.352,208,48.944V16c0-8.832-7.168-16-16-16c-8.832,0-16,7.168-16,16v32.944
            C109.368,56.352,56.352,109.368,48.944,176H16c-8.832,0-16,7.168-16,16c0,8.832,7.168,16,16,16h32.944
            C56.352,274.632,109.368,327.648,176,335.056V368c0,8.832,7.168,16,16,16c8.832,0,16-7.168,16-16v-32.944
            c66.632-7.408,119.648-60.424,127.056-127.056H368c8.832,0,16-7.168,16-16C384,183.168,376.832,176,368,176z M192,304
            c-61.76,0-112-50.24-112-112S130.24,80,192,80s112,50.24,112,112S253.76,304,192,304z"/>
        </svg>
      </div>
    </div>
    <div class="builder-area" ref="builderArea">
      <div class="steps-row" v-for="(stepRow, rowIndex) in stepRows" :key="rowIndex">
        <template v-for="(stepRowItem, rowItemIndex) in stepRow">
          <div class="step-item empty-blank" v-if="!stepRowItem" :key="rowItemIndex"></div>
          <step-item
            v-else
            :class="{'entry-step': !rowIndex}"
            :step="stepRowItem"
            :flow-name="!rowIndex && entryItem.name"
            @add-step="addStep"
            @delete-step="deleteStep"
            :key="rowItemIndex"
            :ref="stepRowItem.id"
            ></step-item>
        </template>
      </div>
      <arrows ref="arrows" :refs="builder" :arrows="arrows" :scale="scaleValue"></arrows>
    </div>
  </div>
</template>

<script>
import panzoom from 'panzoom';
import stepItem from './stepItem';
import arrows from './arrows';
import Vue from 'vue';
import utils from '../utils'

let zoomTimeout = null;

export default {
  data() {
    return {
      zoomTool: null,
      scaleValue: 1,
      arrows: [],
    }
  },

  props: ['entryItem', 'hasWarning'],

  components: {
    stepItem,
    arrows,
  },

  computed: {
    stepRows() {
      const { steps } = this.entryItem;
      const stepRows = [];
      const arrows =[];
      let levelIndex = 0;

      steps.forEach((step, index) => {
        if (!index) {
          stepRows.push([step]);
          levelIndex = 1;
        } else {
          stepRows.some((stepRow, rowIndex) => stepRow.some((stepRowItem, rowItemIndex) => {
            if (stepRowItem !== step.id) return;

            levelIndex = rowIndex + 1;
            stepRows[rowIndex].splice(rowItemIndex, 1, step);

            return true;
          }))
        }

        const linkElements = step.elements.filter(element => element.type === 'rule' || element.type === 'linker').map(element => {
          const matchElement = utils.getOnMatchElement(element);
          const target = matchElement.target || (matchElement.onMatch && matchElement.onMatch.target);

          if (!target) return null;

          arrows.push({parent: element.id, child: target});

          return target;
        })

        if (!linkElements.length) return;

        if (!stepRows[levelIndex]) {
          stepRows.push(linkElements)
        } else {
          stepRows[levelIndex].push(...linkElements)
        }
      });

      this.arrows = arrows;

      return stepRows
    },

    builder() {
      return this
    },

    scale: {
      get() {
        const { scaleValue } = this;

        return scaleValue && parseFloat(scaleValue.toFixed(1)) || 1;
      },
      set(value) {
        const { zoomTool, scaleValue } = this;

        if (!zoomTool || scaleValue == value) return;

        clearTimeout(zoomTimeout);

        zoomTimeout = setTimeout(() => {
          this.scaleValue = value;

          this.scaleTo(value / scaleValue);
        }, 100);
      }
    }
  },

  methods: {
    addStep(step) {
      const { entryItem } = this;
      const firstElement = step.elements[0];

      if (firstElement.displaySettings && firstElement.displaySettings.subType === 'message') {
        step.name = 'New message'
      } else if (firstElement.type === 'action') {
        step.name = 'Action'
      } else if (firstElement.type === 'rule') {
        step.name = 'Trigger'
      }

      entryItem.steps.push(step);
    },

    deleteStep(step) {
      const { steps } = this.entryItem;

      steps.some(stepItem => stepItem.elements.some( (element, index) => {
        const matchElement = utils.getOnMatchElement(element);

        if (matchElement && !matchElement.onMatch) return;

        const { target } = matchElement.onMatch;

        if (target !== step.id) return;

        if (element.type == 'linker') {
          stepItem.elements.splice(index, 1)
        } else {
          Vue.set(matchElement, 'onMatch', undefined);
        }

        return true;
      }))

      steps.splice(steps.indexOf(step), 1)
    },

    initZoom() {
      const zoomTool = panzoom(this.$refs.builderArea, {
        maxZoom: 2,
        minZoom: 0.1,
        smoothScroll: false,
        zoomDoubleClickSpeed: 1,
        beforeWheel(event) {
          if (!event.shiftKey) {
            const { x, y } = zoomTool.getTransform();

            zoomTool.moveTo(x - event.deltaX, y - event.deltaY)
          }

          return !event.shiftKey;
        },
        filterKey(event) {
          return true;
        }
      })

      zoomTool.on('zoom', () => {
        this.scaleValue = zoomTool.getTransform().scale;
      })

      this.zoomTool = zoomTool;
    },

    scaleTo(ration) {
      const { zoomTool } = this;
      const { flowBuilder } = this.$refs;
      const flowBuilderRect = flowBuilder.getBoundingClientRect();

      const positionX = (flowBuilderRect.x + flowBuilderRect.width) / 2;
      const positionY = (flowBuilderRect.y + flowBuilderRect.height) / 2;

      zoomTool.smoothZoom(positionX, positionY, ration);
    },

    findEntryStep() {
      const { zoomTool, entryItem } = this;
      const { flowBuilder } = this.$refs;
      const campaignCard = this.$refs[entryItem.steps[0].id][0];
      const campaignCardRect = campaignCard.$el.getBoundingClientRect();
      const flowBuilderRect = flowBuilder.getBoundingClientRect();
      const { x, y } = zoomTool.getTransform();

      const positionX = -((campaignCardRect.x + campaignCardRect.width / 2) - x - (flowBuilderRect.x + flowBuilderRect.width) / 2);
      const positionY = -((campaignCardRect.y + campaignCardRect.height / 2) - y - (flowBuilderRect.y + flowBuilderRect.height) / 2);

      zoomTool.moveTo(positionX, positionY)
    },
  },

  watch:{
    entryItem: {
      handler: function (entry, oldEntry) {

        if (this.$refs.arrows) this.$nextTick(this.$refs.arrows.recalcPathes);

        if (entry) {
          if (!oldEntry && this._isMounted) {
            this.$nextTick(() => {
              this.initZoom();
              this.findEntryStep();
            });
          };
        }

        if (!oldEntry || !entry || entry.id !== oldEntry.id) {
          return;
        }

        entry.isActive = entry.isEnabled && !this.hasWarning;
        entry.isIncomplete = this.hasWarning;
      },
      deep: true
    },
  }
}
</script>

<style lang="scss">
.flow-builder {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
  outline: none;

  .builder-area {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100%;
    position: relative;
  }

  .steps-row {
    margin-left: 60px;
    display: flex;
    flex-direction: column;
  }

  .zoom-element {
    display: flex;
    align-items: center;
    position: fixed;
    background-color: #fff;
    padding: 0 0 0 10px;
    z-index: 10;
    top: 105px;
    left: calc(50% - 10px);
    width: 230px;
    border: 2px solid #E8E8E8;
    border-radius: 10px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.16);

    .el-slider {
      flex-grow: 1;
    }

    .go-to-position {
      flex-shrink: 0;
      width: 33px;
      margin: 2px 0 0 10px;
      padding: 0 5px;
      border-left: 2px solid #E8E8E8;
    }
  }
}
</style>
