<template>
  <drop 
    :class="{'campaign-builder': true, dragged}" 
    v-if="currentCampaign" 
    tag="div"
    @dragover="dragEnter"
    @dragleave="dragLeave"
    @drop="dropHandler"
  >
    <campaign-card :campaign="currentCampaign" :ref="campaignStep.id"></campaign-card>
    <step-card :step="step" v-for="step in steps" :key="step.id" ref="steps" @delete-step="deleteStep"></step-card>
    <builder-elements></builder-elements>
    <arrows ref="arrows" :refs="$refs" :arrows="arrows"></arrows>
  </drop>    
</template>
<script>
import debounce from 'lodash/debounce'
import campaignCard from '../component/builder-cards/campaignCard.vue'
import stepCard from '../component/builder-cards/stepCard.vue'
import arrows from '../component/arrows.vue'
import { Drop } from 'vue-drag-drop';
import builderElements from '../component/builderElements.vue'

export default {
  beforeRouteEnter(to, from, next) {
    next(accountCampaign => {
      accountCampaign.setCurrentCampaign(to);
    })
  },

  beforeRouteUpdate(to, from, next) {
    this.currentCampaign = null;

    this.setCurrentCampaign(to);
    next();
  },

  data() {
    return {
      currentCampaign: null,
      dragged: false
    }
  },

  components: {
    builderElements,
    campaignCard,
    stepCard,
    Drop,
    arrows
  },  

  computed:{
    steps() {
      return this.currentCampaign.steps.filter(step => step.type == 'regular')
    },

    campaignStep() {
      return this.currentCampaign.steps.find(step => step.type = 'campaignEntry')
    },

    arrows() {
      const { currentCampaign } = this
      const arrows = [];

      currentCampaign.steps.forEach(step => step.elements.find(element => {
        if (element.type != 'goToStep') return;

        arrows.push({ parent: step.id, child: element.value.stepId});

        return true;
      }))

      return arrows;
    }
  },

  methods: {
    setCurrentCampaign(route) {
      const { campaignId } = route.params;
      const { campaignList } = this.$store.state.currentAccount;

      if (!campaignList || !campaignId) return;

      const currentCampaign = campaignList.find(campaign => campaign.id == campaignId);

      currentCampaign.steps.forEach(step => {
        if (step.displaySettings) return;

        Object.assign(step, {
          displaySettings: {
            positionX: null,
            positionY: null,
            collapsed: false
          }
        })
      })

      if (currentCampaign) {
        this.currentCampaign = currentCampaign;
      } else {
        this.$store.dispatch('getCampaignTemplates', { campaign:currentCampaign })
          .then(({ data }) => {
            this.currentCampaign = data.campaign;
          });
      }
    },

    saveCampaign: debounce(function() {

      this.$store.dispatch('saveCampaign', this.currentCampaign)
        .then(({ data }) => {
          this.$message.success({
            message: 'Success saved',
            duration: 3000,
            center: true
          });
        })
        .catch(() => {
          this.$message.error({
            message: 'Error saved',
            duration: 3000,
            center: true
          })
        });
    }, 3000),

    dragEnter(data) {
      if (data.type != "regular") return;

      this.dragged = true;
    },

    dragLeave(data) {
      if (data.type != "regular") return;
      
      this.dragged = false;
    },

    dropHandler(data, event) {
      this.dragged = false;

      if (data.type != "regular") return;

      data.id = this.utils.uuidv4();

      this.currentCampaign.steps.push({
        ...data, 
        displaySettings:{ 
          positionX: event.offsetX - 20, 
          positionY: event.offsetY - 20, 
          collapsed: false
        } 
      });
    },

    deleteStep(step) {
      const { steps } = this.currentCampaign;
      
      steps.splice(steps.indexOf(step),1)
    }
  },


  watch:{
    '$store.state.accounts'() {
      if (this.currentCampaign) return;

      this.setCurrentCampaign(this.$route);
    },

    currentCampaign: {
      handler: function (campaign, oldCampaign) {
        if (this.$refs.arrows) this.$nextTick(this.$refs.arrows.recalcPathes);
        
        if (!oldCampaign || !campaign || campaign.id !== oldCampaign.id) return;

        this.saveCampaign();
      },
      deep: true
    },
  }
}
</script>
<style lang="scss">
.campaign-builder {
  position: absolute;
  overflow: auto;
  height: 100%;
  width:100%;
  transition: background-color .4s;

  &.dragged {
    background-color:#E2E2E2
  }
}
</style>
